

%let variables = 
BABY_REV_AED
FAMILY_REV_AED
FEMALE_REV_AED
Gender_M_dummy
ISC_nat_dummy
KIDS_REV_AED
LMG_EFFECTIVE_POINTS
Local_nat_dummy
Lstg_sgmnt_1
Lstg_sgmnt_2
Lstg_sgmnt_3
Lstg_sgmnt_4
Lstg_sgmnt_5
Lstg_sgmnt_6
MALE_REV_AED
Rev_BS_perc
Rev_HB_perc
Rev_HC_perc
Rev_MX_perc
Rev_SH_perc
Rev_SM_perc
TEEN_REV_AED
UNCLASSIFIED_REV_AED
Units_BS_perc
Units_HB_perc
Units_HC_perc
Units_MX_perc
Units_SH_perc
Units_SM_perc
active_time_BS
active_time_BS3
active_time_BS6
active_time_BS9
active_time_HB
active_time_HB3
active_time_HB6
active_time_HB9
active_time_HC
active_time_HC3
active_time_HC6
active_time_HC9
active_time_MX
active_time_MX3
active_time_MX6
active_time_MX9
active_time_SH
active_time_SH3
active_time_SH6
active_time_SH9
active_time_SM
active_time_SM3
active_time_SM6
active_time_SM9
active_time_lmg
active_time_lmg3
active_time_lmg6
active_time_lmg9
age_grp_1_dummy
age_grp_2_dummy
age_grp_3_dummy
age_grp_5_dummy
age_grp_6_dummy
avg_units_per_txn_BS
avg_units_per_txn_BS3
avg_units_per_txn_BS6
avg_units_per_txn_BS9
avg_units_per_txn_HB3
avg_units_per_txn_HB6
avg_units_per_txn_HC
avg_units_per_txn_HC3
avg_units_per_txn_MX
avg_units_per_txn_MX3
avg_units_per_txn_MX6
avg_units_per_txn_MX9
avg_units_per_txn_SH
avg_units_per_txn_SH3
avg_units_per_txn_SH6
avg_units_per_txn_SH9
avg_units_per_txn_SM
avg_units_per_txn_SM3
avg_units_per_txn_SM6
avg_units_per_txn_SM9
avg_units_per_txn_lmg
avg_units_per_txn_lmg3
avg_units_per_txn_lmg6
avg_units_per_txn_lmg9
avg_units_per_visit_BS
avg_units_per_visit_BS3
avg_units_per_visit_BS6
avg_units_per_visit_HB3
avg_units_per_visit_HB6
avg_units_per_visit_HC
avg_units_per_visit_HC3
avg_units_per_visit_MX
avg_units_per_visit_MX3
avg_units_per_visit_MX6
avg_units_per_visit_MX9
avg_units_per_visit_SH
avg_units_per_visit_SH3
avg_units_per_visit_SH6
avg_units_per_visit_SH9
avg_units_per_visit_SM
avg_units_per_visit_SM3
avg_units_per_visit_SM6
avg_units_per_visit_lmg
avg_units_per_visit_lmg3
avg_units_per_visit_lmg6
avg_units_per_visit_lmg9
concept_count
concept_count_lmg3
concept_count_lmg6
concept_count_lmg9
distinct_prod_BS
distinct_prod_BS3
distinct_prod_HB
distinct_prod_HB3
distinct_prod_HB6
distinct_prod_HB9
distinct_prod_HC
distinct_prod_HC3
distinct_prod_HC6
distinct_prod_HC9
distinct_prod_MX3
distinct_prod_SH3
distinct_prod_SM6
lang_Arabic_dummy
no_of_txn_BS3
no_of_txn_BS6
no_of_txn_HB3
no_of_txn_HB6
no_of_txn_HC
no_of_txn_HC3
no_of_txn_HC6
no_of_txn_MX3
no_of_txn_MX6
no_of_txn_SH3
no_of_txn_SM3
no_of_txn_SM6
no_of_txn_lmg3
no_of_visits_BS3
no_of_visits_BS6
no_of_visits_HB3
no_of_visits_HB6
no_of_visits_HC
no_of_visits_HC3
no_of_visits_MX3
no_of_visits_MX6
no_of_visits_SM3
no_of_visits_SM6
no_of_visits_lmg3
no_of_visits_lmg6
recency_BS
recency_BS3
recency_BS6
recency_BS9
recency_HB
recency_HB3
recency_HB6
recency_HB9
recency_HC
recency_HC3
recency_HC6
recency_HC9
recency_MX
recency_MX3
recency_MX6
recency_MX9
recency_SH
recency_SH3
recency_SH6
recency_SH9
recency_SM
recency_SM3
recency_SM6
recency_SM9
recency_lmg
recency_lmg3
recency_lmg6
recency_lmg9
sum_revenue_aed_BS
sum_revenue_aed_BS3
sum_revenue_aed_BS6
sum_revenue_aed_HB
sum_revenue_aed_HB3
sum_revenue_aed_HB6
sum_revenue_aed_HB9
sum_revenue_aed_HC
sum_revenue_aed_HC3
sum_revenue_aed_HC6
sum_revenue_aed_MX
sum_revenue_aed_MX3
sum_revenue_aed_MX6
sum_revenue_aed_SH3
sum_revenue_aed_SH6
sum_revenue_aed_SM3
sum_revenue_aed_SM6
sum_revenue_aed_lmg
total_points_BS
total_points_BS3
total_points_BS6
total_points_BS9
total_points_HB
total_points_HB3
total_points_HB6
total_points_HB9
total_points_HC
total_points_HC3
total_points_HC6
total_points_HC9
total_points_MX
total_points_MX3
total_points_MX6
total_points_MX9
total_points_SH
total_points_SH3
total_points_SH6
total_points_SH9
total_points_SM
total_points_SM3
total_points_SM6
total_points_SM9
total_points_lmg
total_points_lmg3
total_points_lmg6
total_unit_BS
total_unit_BS9
total_unit_HB
total_unit_HB3
total_unit_HB6
total_unit_HB9
total_unit_HC
total_unit_HC3
total_unit_HC6
total_unit_HC9
total_unit_SH3
total_unit_SM3
total_unit_SM6


;




%let variables1 = 
FAMILY_REV_AED
FEMALE_REV_AED
Gender_M_dummy
/*ISC_nat_dummy*/
KIDS_REV_AED
Local_nat_dummy
Lstg_sgmnt_1
Lstg_sgmnt_2
Lstg_sgmnt_3
Lstg_sgmnt_4
/*Lstg_sgmnt_5*/
Lstg_sgmnt_6
Rev_HC_perc
Rev_MX_perc
UNCLASSIFIED_REV_AED
active_time_HC9
age_grp_5_dummy
/*age_grp_6_dummy*/
avg_units_per_visit_lmg
/*sum_revenue_aed_HB3*/
/*sum_revenue_aed_HC*/
sum_revenue_aed_MX6
/*total_points_BS6*/
total_points_SM3

;


%let variables2 = 
/*BABY_REV_AED*/
/*FAMILY_REV_AED*/
FEMALE_REV_AED
Gender_M_dummy
ISC_nat_dummy
/*KIDS_REV_AED*/
LMG_EFFECTIVE_POINTS
Local_nat_dummy
Lstg_sgmnt_1
Lstg_sgmnt_2
Lstg_sgmnt_4
/*Lstg_sgmnt_5*/
Lstg_sgmnt_6
Rev_MX_perc
Rev_SM_perc
/*TEEN_REV_AED*/
/*UNCLASSIFIED_REV_AED*/
Units_HC_perc
active_time_lmg
/*active_time_lmg3*/
/*age_grp_5_dummy*/
concept_count
no_of_txn_BS3
no_of_txn_HC3
no_of_txn_SM6
/*recency_HC*/
/*recency_SM*/
recency_lmg
recency_lmg3
/*recency_lmg6*/
recency_lmg9
/*sum_revenue_aed_HB*/
/*total_points_HC6*/
total_points_lmg3
/*total_unit_BS*/

;

proc reg data= spdtmp7.VB_AQ_LS_Alldata16_Train ;
    model Bought_flag =  &variables2./ VIF;
run; 


ODS graphics on;
proc logistic data = spdtmp7.VB_AQ_LS_Alldata16_Train plots=ROC  
     outest = spdtmp7.VB_AQ_LS_Train_sv   /* this has list of Significant Vars*/
     outmodel = spdtmp7.VB_AQ_LS_Train_scores  /* this is used for scoring, also has significant variables */
     descending  ;
model  Bought_flag = &variables2. /lackfit rsquare ctable outroc=ROC_sd;
output out = spdtmp7.VB_AQ_LS_Alldata16_Train_res    p = pred_RESPONSE ;
 roc; 
run;
ods graphics off;


/* KS computation */

proc npar1way data=spdtmp7.VB_AQ_LS_Alldata16_Train_res edf;
        class Bought_flag;
        var pred_RESPONSE;
 run;

/* Confusion Matrix for Precision and Recall*/ 
 
  
data spdtmp7.VB_AQ_LS_Alldata16_Train_Conf;
set spdtmp7.VB_AQ_LS_Alldata16_Train_res;

if pred_response >= 0.0089 then prediction = 1;
else prediction = 0;
run;

proc freq data= spdtmp7.VB_AQ_LS_Alldata16_Train_Conf;
        table Bought_flag * prediction ;
run;



/* Lift calculation */

 proc rank data=spdtmp7.VB_AQ_LS_Alldata16_Train_res out= spdtmp7.VB_AQ_LS_Alldata16_Train_dec ties=low
 descending groups=10;
 var pred_RESPONSE;
 ranks decile;
 run;

proc sql;
 select sum(Bought_flag) into: total_hits
 from spdtmp7.VB_AQ_LS_Alldata16_Train_res
 ;
 create table spdtmp7.VB_AQ_LS_Alldata16_Train_lift as
 select sum(Bought_flag)/&total_hits as true_positive_rate,decile + 1 as decile
 from spdtmp7.VB_AQ_LS_Alldata16_Train_dec
 group by decile
 order by decile
 ;
 quit;


 data cum_lift;
 set spdtmp7.VB_AQ_LS_Alldata16_Train_lift;
 cum_positive_rate + true_positive_rate;
 cum_lift=cum_positive_rate/(decile/10);
 run;

 
















 